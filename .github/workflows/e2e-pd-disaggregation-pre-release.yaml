name: E2E PD-Disaggregation Pre-Release Test

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to test (e.g., v1.0.0)"
        required: true
        default: ""
        type: string
      wait_for_termination:
        description: "Wait time (in minutes) before terminating for debugging"
        required: true
        default: 0
        type: number
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+-rc[0-9]+"

permissions:
  packages: read
  contents: read

jobs:
  e2e-test:
    name: E2E PD-Disaggregation Test
    runs-on: [self-hosted, github-runner]
    concurrency:
      group: e2e-pd-test
      cancel-in-progress: false

    container:
      image: golang:1.24
      options: --user root

    outputs:
      test_passed: ${{ steps.validate.outputs.test_passed }}

    env:
      KUBECONFIG: /tmp/kubeconfig
      VERSION: ${{ github.event.inputs.version || github.ref_name }}
      NAMESPACE: mif
      MIF_CHART_PATH: deploy/helm/moai-inference-framework
      TEST_MODEL: "Qwen/Qwen3-0.6B"

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          persist-credentials: false
          ref: ${{ env.VERSION }}

      - name: Determine version
        id: version
        run: |
          if [ -z "$VERSION" ]; then
            echo "❌ Version is required"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Testing version: $VERSION"

      - name: Install kubectl
        run: |
          apt-get update
          apt-get install -y apt-transport-https ca-certificates curl gpg
          curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
          echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
          apt-get update
          apt-get install -y kubectl
          kubectl version --client

      - name: Install Helm
        run: |
          apt-get update
          apt-get install -y curl
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Set up kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_BASE64 }}" | base64 --decode > $KUBECONFIG
          chmod 600 $KUBECONFIG
          kubectl cluster-info
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run E2E PD-Disaggregation test
        id: validate
        env:
          NAMESPACE: ${{ env.NAMESPACE }}
          MIF_CHART_PATH: ${{ env.MIF_CHART_PATH }}
          TEST_MODEL: ${{ env.TEST_MODEL }}
          KUBECONFIG: ${{ env.KUBECONFIG }}
          SKIP_CERT_MANAGER: "false"
          SKIP_CLEANUP: "false"
        run: |
          go test -tags=e2e -v ./test/e2e/... -timeout 30m
          if [ $? -eq 0 ]; then
            echo "test_passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "test_passed=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Collect test reports
        if: always()
        run: |
          mkdir -p test-reports
          if [ -d "./test/e2e" ]; then
            find ./test/e2e -name "*.log" -o -name "*.xml" | xargs -I {} cp {} test-reports/ || true
          fi

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mif-e2e-test-reports-${{ github.run_id }}
          path: test-reports
          retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-test]
    if: always()

    steps:
      - name: Check test result
        run: |
          if [ "${{ needs.e2e-test.outputs.test_passed }}" == "true" ]; then
            echo "✅ E2E tests passed. Ready for production release."
            echo "::notice::E2E tests passed. You can now create a production tag."
          else
            echo "❌ E2E tests failed. Please check the logs and fix issues before releasing."
            echo "::error::E2E tests failed. Production release blocked."
            exit 1
          fi
