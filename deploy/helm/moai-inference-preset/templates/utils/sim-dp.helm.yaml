apiVersion: odin.moreh.io/v1alpha1
kind: InferenceServiceTemplate
metadata:
  name: sim-dp
  namespace: {{ include "common.names.namespace" . }}
  labels:
    {{- include "mif.utils.labels" . | nindent 4 }}
spec:
  workerTemplate:
    metadata:
      labels:
        mif.moreh.io/dummy: dummy # DEPRECATED
    spec:
      containers:
        - name: main
          image: ghcr.io/llm-d/llm-d-inference-sim:v0.7.1
          command:
            - /bin/bash
            - -c
          args:
            - |
              set -ex

              cleanup() {
                echo "Received SIGTERM, killing child processes..."
                pkill -P $$
                wait
              }
              trap cleanup SIGTERM SIGINT

              if [ -n "$ISVC_PRE_PROCESS_SCRIPT" ]; then
                echo "Running pre-process script..."
                eval "$ISVC_PRE_PROCESS_SCRIPT"
              fi

              _dp_size={{ "{{" }} or .Spec.Parallelism.Data 1 {{ "}}" }}
              _dp_local_size={{ "{{" }} or .Spec.Parallelism.DataLocal 1 {{ "}}" }}
              _start_rank=$(( ${LWS_WORKER_INDEX:-0} * _dp_local_size ))

              for ((_index=0; _index<_dp_local_size; _index++)); do
                /app/llm-d-inference-sim \
                  --model "${ISVC_MODEL_PATH}" \
                  --served-model-name "${ISVC_MODEL_NAME}" \
                  --port $((8000 + _index)) \
                  --data-parallel-rank $((_start_rank + _index)) \
                  $(ISVC_EXTRA_ARGS) \
                  &
              done

              wait
          env:
            - name: ISVC_MODEL_NAME
              value: "meta-llama/Llama-3.2-1B-Instruct"
            - name: ISVC_MODEL_PATH
              value: "$(ISVC_MODEL_NAME)" # use "fake-model" to avoid the time and network overhead of tokenization
            - name: ISVC_EXTRA_ARGS
              value: >-
                --max-model-len 8192
                --max-num-seqs 128
                --time-to-first-token 500ms
                --time-to-first-token-std-dev 50ms
                --inter-token-latency 50ms
                --inter-token-latency-std-dev 5ms
          ports:
            - name: http
              containerPort: 8000
            - name: http1
              containerPort: 8001
            - name: http2
              containerPort: 8002
            - name: http3
              containerPort: 8003
            - name: http4
              containerPort: 8004
            - name: http5
              containerPort: 8005
            - name: http6
              containerPort: 8006
            - name: http7
              containerPort: 8007
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
