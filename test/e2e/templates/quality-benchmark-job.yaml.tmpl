apiVersion: batch/v1
kind: Job
metadata:
  generateName: quality-benchmark-
  labels:
    app: quality-benchmark
  namespace: {{.Namespace}}
spec:
  template:
    metadata:
      labels:
        app: quality-benchmark
        sidecar.istio.io/inject: "false"
    spec:
      restartPolicy: Never
      containers:
      - name: quality-benchmark
        image: python:3.11-slim
        command:
        - /bin/bash
        - -c
        args:
        - |
          set -e
          
          # Install system dependencies
          apt-get update
          apt-get install -y curl git bc # bc required for LIMIT calculation
          
          # Clone moreh-llm-eval repository
          echo "Cloning moreh-llm-eval repository..."
          # Configure Git to use token via credential helper instead of embedding it in the URL
          export GITHUB_TOKEN="{{.GithubToken}}"
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "Error: GITHUB_TOKEN is required to clone moreh-llm-eval repository"
            exit 1
          fi

          git config --global credential.helper store
          # Store credentials in a file used by the credential helper
          printf "https://%s:x-oauth-basic@github.com\n" "$GITHUB_TOKEN" > ~/.git-credentials

          if ! git clone --depth 1 --branch {{.QualityEvalBranch}} {{.QualityEvalRepo}} /workspace/moreh-llm-eval; then
            echo "Error: Failed to clone moreh-llm-eval repository with configured Git credentials"
            exit 1
          fi

          # Best-effort cleanup of credentials from disk and environment
          rm -f ~/.git-credentials
          unset GITHUB_TOKEN
          cd /workspace/moreh-llm-eval
          
          # Install Python dependencies
          echo "Installing Python dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Set up environment variables
          export HOST="{{.GatewayHost}}"
          export PORT="{{.GatewayPort}}"
          export MODEL_PATH="{{.ModelName}}"
          export BENCHMARK="{{.Benchmarks}}"
          export LIMIT="{{.Limit}}"
          
          RESULTS_DIR="/workspace/results"
          mkdir -p "$RESULTS_DIR"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          echo "=========================================="
          echo "Running quality benchmark test"
          echo "Benchmark: ${BENCHMARK}"
          echo "Limit: ${LIMIT}"
          echo "Model: ${MODEL_PATH}"
          echo "Endpoint: http://${HOST}:${PORT}"
          echo "=========================================="
          echo ""
          
          RESULTS_FILE="${RESULTS_DIR}/${BENCHMARK}_${TIMESTAMP}.log"
          
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Running benchmark: ${BENCHMARK}"
          echo "Results will be saved to: ${RESULTS_FILE}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Run the sample benchmark for minimal testing.
          # The LIMIT value is passed via the LIMIT environment variable and
          # is consumed by the underlying evaluation script.
          if bash run.sh --eval "${BENCHMARK}" --model "${MODEL_PATH}" --host "${HOST}" --port "${PORT}" 2>&1 | tee "${RESULTS_FILE}"; then
            echo "✅ Benchmark ${BENCHMARK} completed successfully"
          else
            echo "❌ Benchmark ${BENCHMARK} failed"
            exit 1
          fi
          
          echo ""
          
          # Extract summary if available
          if [ -f "${RESULTS_FILE}" ]; then
            echo "=== ${BENCHMARK} Summary ==="
            tail -30 "${RESULTS_FILE}" || true
            echo ""
          fi
          
          echo "=========================================="
          echo "Benchmark Results Summary"
          echo "=========================================="
          echo "Benchmark: ${BENCHMARK}"
          echo "Status: Completed"
          
          echo "✅ Minimal benchmark test passed!"
        {{- if or .HFToken .HFEndpoint }}
        env:
          {{- if .HFToken }}
          - name: HF_TOKEN
            value: "{{ .HFToken }}"
          {{- end }}
          {{- if .HFEndpoint }}
          - name: HF_ENDPOINT
            value: "{{ .HFEndpoint }}"
          {{- end }}
        {{- end }}