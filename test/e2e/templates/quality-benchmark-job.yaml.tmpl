apiVersion: batch/v1
kind: Job
metadata:
  generateName: quality-benchmark-
  labels:
    app: quality-benchmark
  namespace: {{.Namespace}}
spec:
  template:
    metadata:
      labels:
        app: quality-benchmark
        sidecar.istio.io/inject: "false"
    spec:
      restartPolicy: Never
      imagePullSecrets:
        - name: {{ .ImagePullSecret }}
      containers:
      - name: quality-benchmark
        image: 255250787067.dkr.ecr.ap-northeast-2.amazonaws.com/moreh-llm-eval:v0.0.1
        command:
        - /bin/bash
        - -c
        args:
        - |
          set -e
          # Install curl if not present
          if ! command -v curl &> /dev/null; then
            echo "Installing curl..."
            apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
          fi
          # Execute the original entrypoint with arguments
          # Pass arguments as separate strings to avoid shell quoting issues
          exec /usr/local/share/moreh-llm-eval/run.sh \
            --eval "{{.Benchmarks}}" \
            --model "{{.ModelName}}" \
            --host "{{.GatewayHost}}" \
            --port "{{.GatewayPort}}"
        {{- if or .HFToken .HFEndpoint .Limit }}
        env:
          {{- if .HFToken }}
          - name: HF_TOKEN
            value: "{{ .HFToken }}"
          {{- end }}
          {{- if .HFEndpoint }}
          - name: HF_ENDPOINT
            value: "{{ .HFEndpoint }}"
          {{- end }}
          {{- if .Limit }}
          - name: LIMIT
            value: "{{.Limit}}"
          {{- end }}
        {{- end }}