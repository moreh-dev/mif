apiVersion: batch/v1
kind: Job
metadata:
  generateName: quality-benchmark-
  labels:
    app: quality-benchmark
  namespace: {{.Namespace}}
spec:
  template:
    metadata:
      labels:
        app: quality-benchmark
        sidecar.istio.io/inject: "false"
    spec:
      restartPolicy: Never
      imagePullSecrets:
        - name: {{ .ImagePullSecret }}
      containers:
      - name: quality-benchmark
        image: 255250787067.dkr.ecr.ap-northeast-2.amazonaws.com/moreh-llm-eval:v0.0.1
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -e
            {{- if not .IsKind }}
            echo "Setting up writeable cache layer..."
            mkdir -p /tmp/hf_cache
            cp -as /mnt/models/. /tmp/hf_cache/
            {{- end }}
            
            exec /usr/local/bin/run \
              --eval "{{.Benchmarks}}" \
              --model "{{.ModelName}}" \
              --host "{{.GatewayHost}}" \
              --port "{{.GatewayPort}}" \
        {{- if not .IsKind }}
        volumeMounts:
          - name: model
            mountPath: /mnt/models
          - name: writable-cache
            mountPath: /tmp/hf_cache
        {{- end }}
        env:
          {{- if not .IsKind }}
          - name: HF_HUB_OFFLINE
            value: "1"
          - name: HF_DATASETS_OFFLINE
            value: "1"
          - name: HF_HOME
            value: /tmp/hf_cache
          {{- end }}
          {{- if .HFToken }}
          - name: HF_TOKEN
            value: "{{ .HFToken }}"
          {{- end }}
          {{- if .HFEndpoint }}
          - name: HF_ENDPOINT
            value: "{{ .HFEndpoint }}"
          {{- end }}
          {{- if .Limit }}
          - name: LIMIT
            value: "{{.Limit}}"
          {{- end }}
      {{- if not .IsKind }}
      volumes:
        - name: model
          persistentVolumeClaim:
            claimName: {{ .PVCName }}
        - name: writable-cache
          emptyDir: {}
      {{- end }}
