global:
  imagePullSecrets:
    - name: {{ .MorehRegistrySecretName }}

config:
  apiVersion: inference.networking.x-k8s.io/v1alpha1
  kind: EndpointPickerConfig
  plugins:
  - type: single-profile-handler
  - type: queue-scorer
  - type: kv-cache-utilization-scorer
  - type: max-score-picker
  - parameters:
      tokenProcessorConfig:
        blockSize: 64
        hashSeed: "12345"
      indexerConfig:
        kvBlockIndexConfig:
          enableMetrics: true
          inMemoryConfig:
            podCacheSize: 10
            size: 100000000
        prefixStoreConfig:
          blockSize: 256
          cacheSize: 500000
        tokenizersPoolConfig:
          modelName: "openai/gpt-oss-20b"
          minPrefixOverlapRatio: 1.0
          local:
            autoDiscoveryDir: "/mnt/models"
          hf:
            enabled: true
          workersCount: 8
      kvEventsConfig:
        concurrency: 8
        topicFilter: kv@
        zmqEndpoint: tcp://*:5557
        discoverPods: false
    type: precise-prefix-cache-scorer
  schedulingProfiles:
  - name: default
    plugins:
    - pluginRef: queue-scorer
      weight: 2
    - pluginRef: kv-cache-utilization-scorer
      weight: 2
    - pluginRef: precise-prefix-cache-scorer
      weight: 3
    - pluginRef: max-score-picker

args:
  - --pool-name=heimdall
  - --config-file=/config/config.yaml
  - -v=5
  - --zap-encoder=json
  - --metrics-endpoint-auth=false
  - --cache-info-metric=vllm:cache_config_info
  - --total-queued-requests-metric=vllm:num_requests_waiting

gateway:
  name: {{ .GatewayName }}
  gatewayClassName: {{ .GatewayClass }}
  {{- if .IstioRev }}
  labels:
    istio.io/rev: {{ .IstioRev }}
  {{- end }}

inferencePool:
  targetPorts:
    - number: 8000

{{- if not .IsKind }}
extraVolumes:
  - name: models
    persistentVolumeClaim:
      claimName: models

extraVolumeMounts:
  - name: models
    mountPath: /mnt/models

tolerations:
  - key: amd.com/gpu
    operator: Exists
    effect: NoSchedule
  - key: benchmark
    operator: Exists
    effect: NoSchedule

affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - mi250-050

{{- end }}